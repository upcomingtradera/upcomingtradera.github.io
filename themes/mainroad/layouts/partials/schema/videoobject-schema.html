{{ $regularPages   := .Site.RegularPages }}
{{ $currentPageURL := .Permalink }}
{{ $videoData := .Site.Data.videos }}
{{ $matchedData := dict }}
{{ $baseURL := .Site.BaseURL }}


{{ $Pages := .Site.Pages }}
{{ $_env := hugo.Environment }}
{{ if eq "production" $_env }}
    {{ warnf "Environment %s" $_env }}
    {{ range $videoData }}
        {{ $vid := . }}
        {{ $strippedVidURL := replace $vid.url "posts/" "" }}
        {{ range $Pages }}
            {{ if strings.Contains .Permalink $strippedVidURL }}
                {{ warnf "Matched permalink: %s" .Permalink }}
                {{ $fullVideoURL := printf "%s/%s" $baseURL $strippedVidURL }}
		{{/* {{ warnf "--vid_url: %s" $fullVideoURL }} */}}
                {{ .Scratch.Set "matchedVideo" $vid }}
            {{ end }}
        {{ end }}
    {{ end }}
{{ end }}

{{/* After the loop, check if there's any matched video data for the current page */}}
{{ with .Scratch.Get "matchedVideo" }}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "VideoObject",
    "name": "{{ .title }}",
    "description": "{{ .description }}",
    "thumbnailUrl": [
    "https://img.youtube.com/vi/{{ .video_id }}/default.jpg",
    "https://img.youtube.com/vi/{{ .video_id }}/mqdefault.jpg",
    "https://img.youtube.com/vi/{{ .video_id }}/hqdefault.jpg",
    "https://img.youtube.com/vi/{{ .video_id }}/sddefault.jpg",
    "https://img.youtube.com/vi/{{ .video_id }}/maxresdefault.jpg"
    ],
    "uploadDate": "{{ .uploadDate }}",
    "duration": "{{ .duration }}",
    "contentUrl": "{{ .contentUrl }}",
    "embedUrl": "{{ .embedUrl }}",
    "interactionStatistic": {
    "@type": "InteractionCounter",
    "interactionType": { "@type": "WatchAction" },
    "userInteractionCount": {{ .interactionStatistic.userInteractionCount }}
    },
    "regionsAllowed": "{{ .regionsAllowed }}"
}
</script>
{{ end }}



{{ range $videoData }}
    {{ $shouldIncludeSchema := false }}
    {{ $modifiedURL := "" }}

    {{ if strings.Contains .url "posts" }}
        {{ $modifiedURL = replace .url "posts" "blog" }}
    {{ else if strings.Contains .url "authors/ut/" }}
        {{ $modifiedURL = replace .url "authors/ut/_" "authors/ut/" }}
    {{ else if strings.Contains .url "about/" }}
        {{ $modifiedURL = .url }}
    {{ end }}

    {{ $fullVideoURL := printf "%s%s" $baseURL $modifiedURL }}
    {{/* {{ printf "Comparing: %s >== %s" $fullVideoURL $currentPageURL }}<br> */}}

    {{ if eq $fullVideoURL $currentPageURL }}
        {{ $shouldIncludeSchema = true }}
    	{{ warnf "INCLUDE SCHEMA: %s with %s" $fullVideoURL $currentPageURL }}
    {{ end }}



    {{ if $shouldIncludeSchema }}
        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "VideoObject",
            "name": "{{ .title }}",
            "description": "{{ .description }}",
            "thumbnailUrl": [
            "https://img.youtube.com/vi/{{ .video_id }}/default.jpg",
            "https://img.youtube.com/vi/{{ .video_id }}/mqdefault.jpg",
            "https://img.youtube.com/vi/{{ .video_id }}/hqdefault.jpg",
            "https://img.youtube.com/vi/{{ .video_id }}/sddefault.jpg",
            "https://img.youtube.com/vi/{{ .video_id }}/maxresdefault.jpg"
            ],
            "uploadDate": "{{ .uploadDate }}",
            "duration": "{{ .duration }}",
            "contentUrl": "{{ .contentUrl }}",
            "embedUrl": "{{ .embedUrl }}",
            "interactionStatistic": {
            "@type": "InteractionCounter",
            "interactionType": { "@type": "WatchAction" },
            "userInteractionCount": {{ .interactionStatistic.userInteractionCount }}
            },
            "regionsAllowed": "{{ .regionsAllowed }}"
        }
        </script>
    {{ end }}

{{ end }}
